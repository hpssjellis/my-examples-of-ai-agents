<!DOCTYPE html>
<html>
<head>
  <title>Simple Chatbot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta charset="UTF-8" />
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";

    let myMessages = [
      { content: "You are a helpful AI agent helping users.", role: "system" }
    ];
    let mySelectedModel = "Llama-3.2-1B-Instruct-q4f16_1-MLC";

    const myEngine = new webllm.MLCEngine();
    myEngine.setInitProgressCallback(report => {
      document.getElementById("chatStats").textContent = report.text;
    });

    async function initializeEngine() {
      document.getElementById("chatStats").classList.remove("hidden");
      mySelectedModel = document.getElementById("modelSelection").value;
      await myEngine.reload(mySelectedModel, { temperature: 1.0, top_p: 1 });
      document.getElementById("sendButton").disabled = false;
    }

    async function generateResponse() {
      const userInput = document.getElementById("userInput").value.trim();
      if (!userInput) return;

      const userMessage = { content: userInput, role: "user" };
      myMessages.push(userMessage);
      updateMessages();

      document.getElementById("userInput").value = "";
      document.getElementById("userInput").placeholder = "Generating...";
      document.getElementById("sendButton").value = "Stop";

      const aiMessage = { content: "Typing...", role: "assistant" };
      myMessages.push(aiMessage);
      updateMessages();

      try {
        let generatedMessage = "";
        const completion = await myEngine.chat.completions.create({
          stream: true,
          messages: myMessages
        });
        for await (const chunk of completion) {
          const delta = chunk.choices[0].delta.content;
          if (delta) {
            generatedMessage += delta;
            myMessages[myMessages.length - 1].content = generatedMessage;
            updateMessages();
          }
        }
        document.getElementById("userInput").placeholder = "Type a message...";
        document.getElementById("sendButton").value = "Send";
      } catch (error) {
        console.error(error);
      }
    }

    function updateMessages() {
      const userMessages = document.getElementById("userMessages");
      const aiMessages = document.getElementById("aiMessages");

      // Clear old content
      userMessages.textContent = "";
      aiMessages.textContent = "";

      // Refill user and AI messages
      myMessages.forEach(message => {
        if (message.role === "user") {
          userMessages.textContent += message.content + "\n";
        } else if (message.role === "assistant") {
          aiMessages.textContent += message.content + "\n";
        }
      });
    }

    // Attach functions to the global window object for access in inline event handlers
    window.initializeEngine = initializeEngine;
    window.generateResponse = generateResponse;

    window.onload = function () {
      const modelSelection = document.getElementById("modelSelection");
      webllm.prebuiltAppConfig.model_list.forEach(model => {
        const option = document.createElement("option");
        option.value = model.model_id;
        option.textContent = model.model_id;
        modelSelection.appendChild(option);
      });
      modelSelection.value = mySelectedModel;
    };
  </script>
</head>
<body>
  <p>Step 1: Initialize WebLLM and Download Model</p>
  <div>
    <select id="modelSelection"></select>
    <input type="button" value="Download" onclick="initializeEngine()" />
  </div>
  <p id="chatStats" class="hidden"></p>

  <div>
    <textarea id="userInput" rows="3" cols="70" placeholder="Type a message..."></textarea>
    <input type="button" id="sendButton" value="Send" disabled onclick="generateResponse()" />
  </div>

  <div>
    <h3>User Messages:</h3>
    <pre id="userMessages" style="border: 1px solid #ccc; padding: 10px;"></pre>
  </div>
  <div>
    <h3>AI Responses:</h3>
    <pre id="aiMessages" style="border: 1px solid #ccc; padding: 10px;"></pre>
  </div>
</body>
</html>
