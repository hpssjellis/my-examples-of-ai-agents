<!DOCTYPE html>
<html>
<head>
  <title>Simple Chatbot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta charset="UTF-8" />
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";

    let myMessages = [
      { content: "You are a helpful AI agent helping users.", role: "system" }
    ];
    let mySelectedModel = "Llama-3.2-1B-Instruct-q4f16_1-MLC";

    const myEngine = new webllm.MLCEngine();
    myEngine.setInitProgressCallback(report => {
      document.getElementById("myChatStats").textContent = report.text;
    });

    async function myInitializeEngine() {
      document.getElementById("myChatStats").classList.remove("hidden");
      mySelectedModel = document.getElementById("myModelSelection").value;
      await myEngine.reload(mySelectedModel, { temperature: 1.0, top_p: 1 });
      document.getElementById("mySendButton").disabled = false;
    }

    async function myGenerateResponse() {
      const myInput = document.getElementById("myUserInput").value.trim();
      if (!myInput) return;

      const myUserMessage = { content: myInput, role: "user" };
      myMessages.push(myUserMessage);
      myAppendMessage(myUserMessage);

      document.getElementById("myUserInput").value = "";
      document.getElementById("myUserInput").placeholder = "Generating...";
      document.getElementById("mySendButton").value = "Stop";

      const myAiMessage = { content: "Typing...", role: "assistant" };
      myAppendMessage(myAiMessage);

      try {
        let myGeneratedMessage = "";
        const completion = await myEngine.chat.completions.create({
          stream: true,
          messages: myMessages
        });
        for await (const chunk of completion) {
          const delta = chunk.choices[0].delta.content;
          if (delta) {
            myGeneratedMessage += delta;
            myUpdateLastMessage(myGeneratedMessage);
          }
        }
        myUpdateLastMessage(myGeneratedMessage);
        document.getElementById("myUserInput").placeholder = "Type a message...";
        document.getElementById("mySendButton").value = "Send";
      } catch (error) {
        console.error(error);
      }
    }

    function myAppendMessage(message) {
      const chatBox = document.getElementById("myChatBox");
      const messageContainer = document.createElement("div");
      messageContainer.classList.add(
        "message-container",
        message.role === "user" ? "user" : "assistant"
      );
      const newMessage = document.createElement("div");
      newMessage.classList.add("message");
      newMessage.textContent = message.content;

      messageContainer.appendChild(newMessage);
      chatBox.appendChild(messageContainer);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function myUpdateLastMessage(content) {
      const allMessages = document.querySelectorAll(".message");
      const lastMessage = allMessages[allMessages.length - 1];
      lastMessage.textContent = content;
    }

    window.onload = function () {
      const modelSelection = document.getElementById("myModelSelection");
      webllm.prebuiltAppConfig.model_list.forEach(model => {
        const option = document.createElement("option");
        option.value = model.model_id;
        option.textContent = model.model_id;
        modelSelection.appendChild(option);
      });
      modelSelection.value = mySelectedModel;
    };
  </script>
</head>
<body>
  <p>Step 1: Initialize WebLLM and Download Model</p>
  <div>
    <select id="myModelSelection"></select>
    <input type="button" value="Download" onclick="myInitializeEngine()" />
  </div>
  <p id="myChatStats" class="hidden"></p>

  <div>
    <textarea id="myUserInput" rows="3" cols="70" placeholder="Type a message..."></textarea>
    <input type="button" id="mySendButton" value="Send" disabled onclick="myGenerateResponse()" />
  </div>
  <div id="myChatBox"></div>
</body>
</html>
